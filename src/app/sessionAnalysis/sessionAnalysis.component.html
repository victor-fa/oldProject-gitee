<app-left-nav></app-left-nav>
<div class="sessionAnalysis" [ngStyle]="{'left': !commonService.isLeftNavClose ? 'calc(240px)' : 'calc(80px)','width': !commonService.isLeftNavClose ? 'calc(100% - 240px)' : 'calc(100% - 80px)'}">

  <nz-card style="width: 100%;">
    <nz-card-tab>
      <nz-tabset nzSize="large">
        <nz-tab [nzTitle]="dataAppTemplate" (nzClick)="changePanel('sessionLog')" *ngIf="commonService.haveMenuPermission('children', '对话日志')">
          <ng-template #dataAppTemplate><i class="anticon anticon-message"></i>对话日志</ng-template>
          <form [formGroup]="searchSessionLogForm" *ngIf="currentPanel === 'sessionLog'">
            <div nz-row class="search_panel">
              <div nz-col nzSpan="2" class="span_down right_alignment">
                日期范围：
              </div>
              <div nz-col nzSpan="7" class="span_down">
                <nz-range-picker formControlName="date" [nzFormat]="'yyyyMMdd'" nzShowTime [nzShowToday]="true" [(ngModel)]="dateRange" [nzRanges]="dateSearch" (ngModelChange)="onChange($event)"></nz-range-picker>
              </div>
              <div nz-col nzSpan="3">
                <button nz-button nzType="primary" (click)="shouSomething('explain')"><i class="anticon anticon-info-circle-o"></i>数据说明？</button>
              </div>
              <div nz-col nzSpan="9"></div>
              <div nz-col nzSpan="3">
                <button nz-button nzType="primary" (click)="shouSomething('sessionLog')">
                  <i class="anticon anticon-plus-circle-o" *ngIf="!isSessionLogSearchVisiable"></i>
                  <i class="anticon anticon-minus-circle-o" *ngIf="isSessionLogSearchVisiable"></i>
                  {{isSessionLogSearchVisiable ? '收起' : '展开'}}筛选区
                </button>
              </div>
            </div>
            <div style="background-color: #F7F7F7;padding: 10px 0px 0px 10px;margin-bottom: 10px;" *ngIf="isSessionLogSearchVisiable">
              <div nz-row class="search_panel">
                <div nz-col nzSpan="24">
                  <div nz-row>
                    <div nz-col nzSpan="24">
                      <label nz-checkbox [(ngModel)]="allSessionBusinessChecked" (ngModelChange)="updateAllChecked()" [nzIndeterminate]="indeterminate" formControlName="checkA">全选</label>
                      <nz-checkbox-group [(ngModel)]="checkOptionsOne" (ngModelChange)="updateSingleChecked()" formControlName="checkB"></nz-checkbox-group>
                    </div>
                  </div>
                </div>
              </div>
              <div nz-row class="search_panel">
                <div nz-col nzSpan="16">
                  <div nz-col nzSpan="7">
                    <input nz-input formControlName="ask" type="text" placeholder="关键词搜问句" nzSize="default">
                  </div>
                  <div nz-col nzSpan="7">
                    <input nz-input formControlName="answer" type="text" placeholder="关键词搜回答" nzSize="default">
                  </div>
                  <div nz-col nzSpan="2">
                    <input nz-input formControlName="uid" type="text" placeholder="输入用户ID" nzSize="default">
                  </div>
                  <div nz-col nzSpan="1" class="span_down right_alignment" style="letter-spacing: -2px;">标记：</div>
                  <div nz-col nzSpan="3" class="span_down">
                    <nz-select [(ngModel)]="sessionLogFlag" formControlName="flag">
                      <nz-option [nzLabel]="'全部'" [nzValue]="0"></nz-option>
                      <nz-option required [nzLabel]="'已标记'" [nzValue]="1"></nz-option>
                      <nz-option required [nzLabel]="'未标记'" [nzValue]="2"></nz-option>
                    </nz-select>
                  </div>
                  <div nz-col nzSpan="2" class="span_down right_alignment" style="letter-spacing: -2px;">
                    异常回答：
                  </div>
                  <div nz-col nzSpan="2">
                    <nz-select [(ngModel)]="abnormalType" formControlName="abnormalType">
                      <nz-option [nzLabel]="'不筛选'" [nzValue]="''"></nz-option>
                      <nz-option [nzLabel]="'全部异常话术'" [nzValue]="'ALL'"></nz-option>
                      <nz-option [nzLabel]="'后端问题话术'" [nzValue]="'BACK_END'"></nz-option>
                      <nz-option [nzLabel]="'业务bot挽回话术'" [nzValue]="'BUSINESS_BOT_DETAINMENT'"></nz-option>
                      <nz-option [nzLabel]="'闲聊兜底话术'" [nzValue]="'FREE_CHAT_SPEECHLESS'"></nz-option>
                    </nz-select>
                  </div>
                </div>
                <div nz-col nzSpan="8">
                  <div nz-col nzSpan="6" class="span_down right_alignment" style="letter-spacing: -2px;">
                    会话内意图数&nbsp;<a (click)="chooseSessionCompare($event, 'conpareFirst')" style="letter-spacing: 7px;font-weight: bold;">{{conpareFirst === '<' ? '<' : '>'}}</a>
                  </div>
                  <div nz-col nzSpan="2" style="margin-right: -15px;">
                    <input nz-input formControlName="intentionNum" type="text" nzSize="default">
                  </div>
                  <div nz-col nzSpan="5" class="span_down right_alignment" style="letter-spacing: -2px;">
                    重复回答&nbsp;<a (click)="chooseSessionCompare($event, 'conpareSecond')" style="letter-spacing: 7px;font-weight: bold;">{{conpareSecond === '<' ? '<' : '>'}}</a>
                  </div>
                  <div nz-col nzSpan="2" style="margin-right: -15px;">
                    <input nz-input formControlName="repetitionNum" type="text" nzSize="default">
                  </div>
                  <div nz-col nzSpan="5" class="span_down right_alignment" style="letter-spacing: -2px;">
                    响应时长&nbsp;<a (click)="chooseSessionCompare($event, 'conpareThird')" style="letter-spacing: 7px;font-weight: bold;">{{conpareThird === '<' ? '<' : '>'}}</a>&nbsp;
                  </div>
                  <div nz-col nzSpan="2">
                    <input nz-input formControlName="cost" type="text" nzSize="default">
                  </div>
                  <div nz-col nzSpan="2" class="span_down">&nbsp;ms</div>
                </div>
              </div>
            </div>
            <div nz-row class="search_panel">
              <div nz-col nzSpan="3">
                <nz-select [(ngModel)]="sessionLogLevel" formControlName="level">
                  <nz-option required [nzLabel]="'只查询符合条件的问答'" [nzValue]="'QA'"></nz-option>
                  <nz-option required [nzLabel]="'包含相同BOT上下文'" [nzValue]="'INTENTION'"></nz-option>
                  <nz-option required [nzLabel]="'包含完整的上下文'" [nzValue]="'SESSION'"></nz-option>
                </nz-select>
              </div>
              <div nz-col nzSpan="1"></div>
              <div nz-col nzSpan="3">
                <button nz-button nzType="primary" (click)="loadData('sessionLogSearch')"><i class="anticon anticon-search"></i>查询</button>
              </div>
              <div nz-col nzSpan="15" class="span_down">共搜索到 {{totalSessionLog}} 条数据</div>
              <div nz-col nzSpan="2">
                <button nz-button nzType="primary" (click)="getExcecl('sessionLog')"><i class="anticon anticon-export"></i>导出</button>
              </div>
            </div>
          </form>
          <nz-table #rowSelectionTable [nzData]="sessionLogData" [nzSimple]="true" [(nzPageSize)]="pageSize" [nzShowPagination]="false" [nzScroll]="{x:'3200px'}" *ngIf="!isSpinning">
            <thead>
              <tr>
                <th nzWidth="30px">序号</th>
                <th nzWidth="60px" *ngIf="checkDataOptions.sessionAnalysis[0].checked">用户ID</th>
                <th nzWidth="50px" *ngIf="checkDataOptions.sessionAnalysis[1].checked">日期</th>
                <th nzWidth="50px" *ngIf="checkDataOptions.sessionAnalysis[2].checked">时间</th>
                <th nzWidth="120px" *ngIf="checkDataOptions.sessionAnalysis[3].checked">用户问询</th>
                <th nzWidth="60px" *ngIf="checkDataOptions.sessionAnalysis[4].checked">BOT</th>
                <th nzWidth="200px" *ngIf="checkDataOptions.sessionAnalysis[5].checked">回答</th>
                <th nzWidth="30px" *ngIf="checkDataOptions.sessionAnalysis[6].checked">操作</th>
                <th nzWidth="60px" *ngIf="checkDataOptions.sessionAnalysis[7].checked">会话ID</th>
                <th nzWidth="60px" *ngIf="checkDataOptions.sessionAnalysis[8].checked">意图ID</th>
                <th nzWidth="60px" *ngIf="checkDataOptions.sessionAnalysis[9].checked">对话ID</th>
                <th nzWidth="100px" *ngIf="checkDataOptions.sessionAnalysis[10].checked">中控回答</th>
                <th nzWidth="60px" *ngIf="checkDataOptions.sessionAnalysis[11].checked">总耗时</th>
                <th nzWidth="60px" *ngIf="checkDataOptions.sessionAnalysis[12].checked">子BOT耗时</th>
                <th nzWidth="60px" *ngIf="checkDataOptions.sessionAnalysis[13].checked">中控耗时</th>
                <th nzWidth="60px" *ngIf="checkDataOptions.sessionAnalysis[14].checked">异常回答</th>
                <th nzWidth="60px" *ngIf="checkDataOptions.sessionAnalysis[15].checked">重复回答</th>
                <th nzWidth="60px" *ngIf="checkDataOptions.sessionAnalysis[16].checked">会话轮数</th>
                <th nzWidth="60px" *ngIf="checkDataOptions.sessionAnalysis[17].checked">会话内意图数量</th>
                <th nzWidth="100px">会话持续时长</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let data of rowSelectionTable.data; let i=index;">
                <td nzWidth="30px" [ngStyle]="{'background-color': data.flag ? '#FFCCCC' : (data.color ? '#E0F5EB' : '#F2F2F2') }">{{i+1}}</td>
                <td nzWidth="60px" [ngStyle]="{'background-color': data.flag ? '#FFCCCC' : (data.color ? '#E0F5EB' : '#F2F2F2') }" *ngIf="checkDataOptions.sessionAnalysis[0].checked">{{data.uid}}</td>
                <!-- <td nzWidth="60px" *ngIf="checkDataOptions.sessionAnalysis[0].checked">{{data.uid}}</td> -->
                <td nzWidth="50px" [ngStyle]="{'background-color': data.flag ? '#FFCCCC' : (data.color ? '#E0F5EB' : '#F2F2F2') }" *ngIf="checkDataOptions.sessionAnalysis[1].checked">{{data.create | date:'yy-MM-dd'}}</td>
                <td nzWidth="50px" [ngStyle]="{'background-color': data.flag ? '#FFCCCC' : (data.color ? '#E0F5EB' : '#F2F2F2') }" *ngIf="checkDataOptions.sessionAnalysis[2].checked">{{data.create | date:'HH:mm:ss'}}</td>
                <td nzWidth="100px" [ngStyle]="{'background-color': data.flag ? '#FFCCCC' : (data.color ? '#E0F5EB' : '#F2F2F2') }" *ngIf="checkDataOptions.sessionAnalysis[3].checked">{{data.ask}}</td>
                <td nzWidth="60px" [ngStyle]="{'background-color': data.flag ? '#FFCCCC' : (data.color ? '#E0F5EB' : '#F2F2F2') }" *ngIf="checkDataOptions.sessionAnalysis[4].checked">{{data.business}}</td>
                <td nzWidth="200px" [ngStyle]="{'background-color': data.flag ? '#FFCCCC' : (data.color ? '#E0F5EB' : '#F2F2F2') }" *ngIf="checkDataOptions.sessionAnalysis[5].checked" nzTitle="{{data.businessAnswer}}" nzPlacement="bottom" nz-tooltip>
                  <a>{{data.businessAnswer ? data.businessAnswer.length > 60 ? data.businessAnswer.substring(0, 60) + '…' : data.businessAnswer : 'null'}}</a>
                </td>
                <td nzWidth="30px" [ngStyle]="{'background-color': data.flag ? '#FFCCCC' : (data.color ? '#E0F5EB' : '#F2F2F2') }" *ngIf="checkDataOptions.sessionAnalysis[6].checked">
                  <button *ngIf="!data.flag" nz-button nzType="primary" (click)="changeFlag(data, 'sessionLog')"><i class="anticon anticon-star"></i>标记</button>
                  <button *ngIf="data.flag" nz-button nzType="primary" (click)="changeFlag(data, 'sessionLog')"><i class="anticon anticon-star"></i>已标记</button>
                </td>
                <td nzWidth="60px" [ngStyle]="{'background-color': data.flag ? '#FFCCCC' : (data.color ? '#E0F5EB' : '#F2F2F2') }" *ngIf="checkDataOptions.sessionAnalysis[7].checked" nzTitle="{{data.sessionId}}" nzPlacement="bottom" nz-tooltip>
                  <a>{{data.sessionId ? data.sessionId.length > 6 ? data.sessionId.substring(0, 6) + '…' : data.sessionId : 'null'}}</a>
                </td>
                <td nzWidth="60px" [ngStyle]="{'background-color': data.flag ? '#FFCCCC' : (data.color ? '#E0F5EB' : '#F2F2F2') }" *ngIf="checkDataOptions.sessionAnalysis[8].checked" nzTitle="{{data.intentionId}}" nzPlacement="bottom" nz-tooltip>
                  <a>{{data.intentionId ? data.intentionId.length > 6 ? data.intentionId.substring(0, 6) + '…' : data.intentionId : 'null'}}</a>
                </td>
                <td nzWidth="60px" [ngStyle]="{'background-color': data.flag ? '#FFCCCC' : (data.color ? '#E0F5EB' : '#F2F2F2') }" *ngIf="checkDataOptions.sessionAnalysis[9].checked" nzTitle="{{data.id}}" nzPlacement="bottom" nz-tooltip>
                  <a>{{data.id ? data.id.length > 6 ? data.id.substring(0, 6) + '…' : data.id : 'null'}}</a>
                </td>
                <td nzWidth="100px" [ngStyle]="{'background-color': data.flag ? '#FFCCCC' : (data.color ? '#E0F5EB' : '#F2F2F2') }" *ngIf="checkDataOptions.sessionAnalysis[10].checked" nzTitle="{{data.cpsAnswer}}" nzPlacement="bottom" nz-tooltip>
                  <a>{{data.cpsAnswer ? data.cpsAnswer.length > 12 ? data.cpsAnswer.substring(0, 12) + '…' : data.cpsAnswer : 'null'}}</a>
                </td>
                <td nzWidth="60px" [ngStyle]="{'background-color': data.flag ? '#FFCCCC' : (data.color ? '#E0F5EB' : '#F2F2F2') }" *ngIf="checkDataOptions.sessionAnalysis[11].checked">{{data.businessCost + data.cpsCost}}</td>
                <td nzWidth="60px" [ngStyle]="{'background-color': data.flag ? '#FFCCCC' : (data.color ? '#E0F5EB' : '#F2F2F2') }" *ngIf="checkDataOptions.sessionAnalysis[12].checked">{{data.businessCost}}</td>
                <td nzWidth="60px" [ngStyle]="{'background-color': data.flag ? '#FFCCCC' : (data.color ? '#E0F5EB' : '#F2F2F2') }" *ngIf="checkDataOptions.sessionAnalysis[13].checked">{{data.cpsCost}}</td>
                <td nzWidth="60px" [ngStyle]="{'background-color': data.flag ? '#FFCCCC' : (data.color ? '#E0F5EB' : '#F2F2F2') }" *ngIf="checkDataOptions.sessionAnalysis[14].checked">{{data.abnormalStatement}}</td>
                <td nzWidth="60px" [ngStyle]="{'background-color': data.flag ? '#FFCCCC' : (data.color ? '#E0F5EB' : '#F2F2F2') }" *ngIf="checkDataOptions.sessionAnalysis[15].checked">{{data.repeatedCounter}}</td>
                <td nzWidth="60px" [ngStyle]="{'background-color': data.flag ? '#FFCCCC' : (data.color ? '#E0F5EB' : '#F2F2F2') }" *ngIf="checkDataOptions.sessionAnalysis[16].checked">{{data.sessionRoundsNum  }}</td>
                <td nzWidth="60px" [ngStyle]="{'background-color': data.flag ? '#FFCCCC' : (data.color ? '#E0F5EB' : '#F2F2F2') }" *ngIf="checkDataOptions.sessionAnalysis[17].checked">{{data.sessionIntentionsNum}}</td>
                <td nzWidth="100px" [ngStyle]="{'background-color': data.flag ? '#FFCCCC' : (data.color ? '#E0F5EB' : '#F2F2F2') }">{{data.sessionDuration}}</td>
              </tr>
            </tbody>
          </nz-table>
          <div nz-row style="margin: 10px 0;line-height: 30px;">
            <div nz-col nzSpan="12"></div>
            <div nz-col nzSpan="2">
              <nz-select [(ngModel)]="sessionLogPageSize">
                <nz-option required [nzLabel]="'5'" [nzValue]="5"></nz-option>
                <nz-option required [nzLabel]="'10'" [nzValue]="10"></nz-option>
                <nz-option required [nzLabel]="'20'" [nzValue]="20"></nz-option>
                <nz-option required [nzLabel]="'50'" [nzValue]="50"></nz-option>
              </nz-select>
            </div>
            <div nz-col nzSpan="1" *ngIf="changeSessionLogPage !== 1 && totalSessionLog !== 0"><button nz-button nzType="primary" (click)="lastPage('sessionLog')"><i class="anticon anticon-left"></i></button></div>
            <div nz-col nzSpan="1" *ngIf="changeSessionLogPage === 1 || totalSessionLog === 0"><button disabled nz-button nzType="primary"><i class="anticon anticon-left"></i></button></div>
            <div nz-col nzSpan="6">当前为 {{changeSessionLogPage}} / {{allSessionLogSize}} 页 &nbsp;&nbsp; 共 {{totalSessionLog}} 条</div>
            <div nz-col nzSpan="1" *ngIf="changeSessionLogPage !== allSessionLogSize && totalSessionLog !== 0"><button nz-button nzType="primary" (click)="nextPage('sessionLog')"><i class="anticon anticon-right"></i></button></div>
            <div nz-col nzSpan="1" *ngIf="changeSessionLogPage === allSessionLogSize || totalSessionLog === 0"><button disabled nz-button nzType="primary"><i class="anticon anticon-right"></i></button></div>
          </div>
        </nz-tab>

        <!-- 弹框 —— 信息 —— 数据说明 -->
        <nz-modal [(nzVisible)]="isExplainVisiable" nzWidth="1450" nzTitle="{{currentTitle}}数据说明" [nzFooter]="ecplainModalFooter" (nzOnCancel)="shouSomething('explain')" nzMaskClosable="false">
            <div nz-row class="search_panel" style="text-align: center;">
              <div nz-col nzSpan="2">
                <span style="line-height: 30px;">&nbsp;</span><br>
                <ng-container *ngIf="currentPanel === 'sessionLog'">
                  <ng-container *ngFor="let item of checkDataOptions.sessionAnalysis; let i=index;">
                    <label nz-checkbox [(nzChecked)]="item.checked" style="line-height: 31px;"></label><br>
                  </ng-container>
                </ng-container>
              </div>
              <div nz-col nzSpan="22">
                <img *ngIf="currentPanel === 'sessionLog'" [src]="'assets/images/sessionAnalysis.png'">
              </div>
            </div>
            <!-- 弹框和底部定制 -->
            <ng-template #ecplainModalFooter>
              <button nz-button nzType="default" (click)="shouSomething('explain')"><i class="anticon anticon-close-circle-o"></i>关闭</button>
            </ng-template>
          </nz-modal>

      </nz-tabset>
      <div class="spin" *ngIf="isSpinning">
        <nz-spin [nzSize]="'large'"></nz-spin>
      </div>
    </nz-card-tab>
  </nz-card>
</div>

