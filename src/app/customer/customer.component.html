<app-left-nav></app-left-nav>
<div class="user" [ngStyle]="{'left': !commonService.isLeftNavClose ? 'calc(240px)' : 'calc(80px)','width': !commonService.isLeftNavClose ? 'calc(100% - 240px)' : 'calc(100% - 80px)'}">
  <nz-card>
    <nz-card-tab>
      <nz-tabset nzSize="large" [(nzSelectedIndex)]="currentTabset">
        <nz-tab [nzTitle]="feedbackTemplate" (nzClick)="changePanel('feedback')" *ngIf="commonService.haveMenuPermission('children', '用户反馈')">
          <ng-template #feedbackTemplate><i class="anticon anticon-swap"></i>用户反馈</ng-template>
          <form [formGroup]="searchFeedBackForm">
            <div nz-row>
              <div nz-col nzSpan="2" class="right_alignment">
                用户账号：
              </div>
              <div nz-col nzSpan="3">
                <input nz-input maxlength="32" formControlName="phone" placeholder="输入用户账号" nzSize="default">
              </div>
              <div nz-col nzSpan="2" class="right_alignment">
                问题类型：
              </div>
              <div nz-col nzSpan="3">
                <nz-select [ngModel]="''" formControlName="type">
                  <nz-option required [nzLabel]="'全部'" [nzValue]="''"></nz-option>
                  <nz-option required *ngFor="let data of problemInfo; let i=index;" [nzLabel]="data.name" [nzValue]="data.name"></nz-option>
                </nz-select>
              </div>
              <div nz-col nzSpan="2" class="right_alignment">
                处理状态：
              </div>
              <div nz-col nzSpan="3">
                <nz-select [ngModel]="''" formControlName="status">
                  <nz-option required [nzLabel]="'全部'" [nzValue]="''"></nz-option>
                  <nz-option required [nzLabel]="'未处理'" [nzValue]="'SUBMITTED'"></nz-option>
                  <nz-option required [nzLabel]="'处理中'" [nzValue]="'DOING'"></nz-option>
                  <nz-option required [nzLabel]="'已完成'" [nzValue]="'DONE'"></nz-option>
                </nz-select>
              </div>
              <div nz-col nzSpan="2" class="right_alignment">
                回复状态：
              </div>
              <div nz-col nzSpan="3">
                <nz-select [ngModel]="''" formControlName="replyStatus">
                  <nz-option required [nzLabel]="'全部'" [nzValue]="''"></nz-option>
                  <nz-option required [nzLabel]="'未回复'" [nzValue]="'false'"></nz-option>
                  <nz-option required [nzLabel]="'已回复'" [nzValue]="'true'"></nz-option>
                </nz-select>
              </div>
            </div>
            <div nz-row>
              <div nz-col nzSpan="2" class="right_alignment">
                反馈时间：
              </div>
              <div nz-col nzSpan="7">
                <nz-range-picker formControlName="date" [nzFormat]="'yyyy-MM-dd'" [nzShowToday]="true" ngModel [nzRanges]="commonService.dateSearch" (ngModelChange)="onChange($event, 'feedback')"></nz-range-picker>
              </div>
              <div nz-col nzSpan="13"></div>
              <div nz-col nzSpan="2">
                <button nz-button nzType="primary" (click)="loadData('feedback')"><i class="anticon anticon-search"></i>查询</button>
              </div>
            </div>
          </form>

          <nz-table nzBordered #rowFeedBackTable [nzData]="feedbackInfo" [nzSimple]="true" nzShowSizeChanger [nzPageSize]="10" *ngIf="!isSpinning">
            <thead>
              <tr>
                <th>序号</th>
                <th>用户账号</th>
                <th>用户昵称</th>
                <th>问题类型</th>
                <th>具体问题</th>
                <th>问题描述</th>
                <th>微信</th>
                <th>邮箱</th>
                <th>QQ</th>
                <th>处理状态</th>
                <th>回复状态</th>
                <th>用户已读</th>
                <th>反馈时间</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let data of rowFeedBackTable.data; let i=index;">
                <td>{{i + 1}}</td>
                <td>{{data.phone}}</td>
                <td>{{data.nickName}}</td>
                <td>{{data.typeName}}</td>
                <td>{{data.concreteProblems}}</td>
                <td nzTitle="{{data.words}}" nzPlacement="bottom" nz-tooltip>
                  <a>{{data.words ? data.words.length > 12 ? data.words.substring(0, 12) + '…' : data.words : 'null'}}</a>
                </td>
                <td>{{data.wxNumber}}</td>
                <td>{{data.email}}</td>
                <td>{{data.qq}}</td>
                <td>{{data.status === 'SUBMITTED' ? '未处理' : data.status === 'DOING' ? '处理中' : data.status === 'DONE' ? '已完成' : '未处理'}}</td>
                <td>{{data.replyStatus === true ? '已回复' : '未回复'}}</td>
                <td>{{data.readStatus === true ? '已读' : '未读'}}</td>
                <td>{{data.date | date:'yyyy-MM-dd HH:mm:ss'}}</td><!-- :'GMT+16:00' -->
                <td>
                  <button nz-button nzType="primary" (click)="showModal(data, 'feedBack')" style="margin-right: 10px;"><i class="anticon anticon-message"></i>回复</button>
                </td>
              </tr>
            </tbody>
          </nz-table>
          <div class="spin" *ngIf="isSpinning">
            <nz-spin [nzSize]="'large'"></nz-spin>
          </div>

          <nz-modal [(nzVisible)]="visiable.feedBack" nzWidth="1150" nzTitle="反馈详情" [nzFooter]="feedBackModalFooter" (nzOnCancel)="hideModal('feedBack')" nzMaskClosable="false">
            <div nz-row>
              <div nz-col nzSpan="4" class="right_alignment">用户账号：</div>
              <div nz-col nzSpan="6">{{tempFeedBack.phone ? tempFeedBack.phone : 'null'}}</div>
              <div nz-col nzSpan="4" class="right_alignment">用户昵称：</div>
              <div nz-col nzSpan="6">{{tempFeedBack.nickName ? tempFeedBack.nickName : 'null'}}</div>
            </div>
            <div nz-row>
              <div nz-col nzSpan="4" class="right_alignment">反馈时间：</div>
              <div nz-col nzSpan="6">{{tempFeedBack.date ? (tempFeedBack.date | date:'yyyy-MM-dd HH:mm:ss':'GMT+16:00') : 'null'}}</div>
              <div nz-col nzSpan="4" class="right_alignment">微信：</div>
              <div nz-col nzSpan="6">{{tempFeedBack.wxNumber ? tempFeedBack.wxNumber : 'null'}}</div>
            </div>
            <div nz-row>
              <div nz-col nzSpan="4" class="right_alignment">QQ：</div>
              <div nz-col nzSpan="6">{{tempFeedBack.qq ? tempFeedBack.qq : 'null'}}</div>
              <div nz-col nzSpan="4" class="right_alignment">邮箱：</div>
              <div nz-col nzSpan="6">{{tempFeedBack.email ? tempFeedBack.email : 'null'}}</div>
            </div>
            <div nz-row>
              <div nz-col nzSpan="4" class="right_alignment">处理状态：</div>
              <div nz-col nzSpan="3" *ngIf="!visiable.editStatus">{{tempFeedBack.status === 'SUBMITTED' ? '未处理' : tempFeedBack.status === 'DOING' ? '处理中' : tempFeedBack.status === 'DONE' ? '已完成' : ''}}</div>
              <div nz-col nzSpan="2" *ngIf="!visiable.editStatus">
                <button nz-button nzType="primary" (click)="showModal('', 'editStatus')"><i class="anticon anticon-edit"></i>修改</button>
              </div>
              <div nz-col nzSpan="9" *ngIf="visiable.editStatus">
                <nz-radio-group [(ngModel)]="tempFeedBack.status">
                  <label nz-radio nzValue="SUBMITTED">未处理</label>
                  <label nz-radio nzValue="DOING">处理中</label>
                  <label nz-radio nzValue="DONE">已完成</label>
                </nz-radio-group>
              </div>
              <div nz-col nzSpan="3" *ngIf="visiable.editStatus">
                <button nz-button nzType="primary" (click)="doSave('editStatus')"><i class="anticon anticon-save"></i>保存</button>
              </div>
              <div nz-col nzSpan="3" *ngIf="visiable.editStatus">
                <button nz-button nzType="default" (click)="hideModal('editStatus')"><i class="anticon anticon-close-circle-o"></i>取消</button>
              </div>
            </div>
            <div nz-row>
              <div nz-col nzSpan="4" class="right_alignment">问题描述：</div>
              <div nz-col nzSpan="17">{{tempFeedBack.date | date:'yyyy-MM-dd HH:mm:ss'}}</div>
            </div>
            <div nz-row>
              <div nz-col nzSpan="4"></div>
              <div nz-col nzSpan="17">{{tempFeedBack.words ? tempFeedBack.words : 'null'}}</div>
            </div>

            <ng-container *ngIf="tempFeedBack.dialogues">
              <ng-container *ngIf="tempFeedBack.dialogues.length > 0">
                <ng-container *ngFor="let item of tempFeedBack.dialogues; let i=index;">
                  <div nz-row>
                    <div nz-col nzSpan="4" class="right_alignment">{{item.userName === 'ADMIN' ? '小悟客服：' : '问题描述：'}}</div>
                    <div nz-col nzSpan="17">{{item.createDate | date:'yyyy-MM-dd HH:mm:ss'}}</div>
                  </div>
                  <div nz-row>
                    <div nz-col nzSpan="4"></div>
                    <div nz-col nzSpan="17">{{item.msg}}</div>
                  </div>
                </ng-container>
              </ng-container>
            </ng-container>
            <div nz-row *ngIf="!visiable.replyUser">
              <div nz-col nzSpan="4"></div>
              <div nz-col nzSpan="4">
                <button nz-button nzType="primary" (click)="showModal('', 'replyUser')"><i class="anticon anticon-message"></i>回复用户</button>
              </div>
            </div>
            <div nz-row *ngIf="visiable.replyUser">
              <div nz-col nzSpan="1"></div>
              <div nz-col nzSpan="23">
                <textarea rows="4" nz-input placeholder="输入回复内容" [(ngModel)]="tempFeedBack.messageTemp" nzSize="default"></textarea>
              </div>
            </div>
            <div nz-row *ngIf="visiable.replyUser">
              <div nz-col nzSpan="1"></div>
              <div nz-col nzSpan="3">
                <button nz-button nzType="primary" (click)="doSave('editReply')"><i class="anticon anticon-save"></i>提交</button>
              </div>
              <div nz-col nzSpan="3">
                <button nz-button nzType="default" (click)="hideModal('replyUser')"><i class="anticon anticon-close-circle-o"></i>取消</button>
              </div>
            </div>

            <div nz-row>
              <div nz-col nzSpan="4" class="right_alignment">上传图片：</div>
              <div nz-col nzSpan="20">
                <ng-container *ngIf="tempFeedBack.photo">
                  {{tempFeedBack.photo.length > 0 ? 'null' : (tempFeedBack.photo.toString().indexOf('http') > -1 ? '' : 'null')}}
                </ng-container>
                <ng-container *ngIf="!tempFeedBack.photo">
                  null
                </ng-container>
              </div>
            </div>
            <ng-container *ngIf="tempFeedBack.photo && tempFeedBack.photo.length > 0">
              <ng-container *ngIf="tempFeedBack.photo.toString().indexOf('http') > -1">
                <div nz-row *ngFor="let item of tempFeedBack.photo; let i=index;" style="margin-bottom: 8px;">
                  <div nz-col nzSpan="6"></div>
                  <div nz-col nzSpan="14"><img [src]="item" style="width: 350px;"></div>
                  <div nz-col nzSpan="4"></div>
                </div>
              </ng-container>
            </ng-container>
            <ng-template #feedBackModalFooter>
              <button nz-button nzType="default" (click)="hideModal('feedBack')"><i class="anticon anticon-close-circle-o"></i>取消</button>
            </ng-template>
          </nz-modal>
        </nz-tab>

        <nz-tab [nzTitle]="problemTemplate" (nzClick)="changePanel('problem')" *ngIf="commonService.haveMenuPermission('children', '用户反馈')">
          <ng-template #problemTemplate><i class="anticon anticon-question-circle-o"></i>反馈问题管理</ng-template>
          <div nz-row>
            <div nz-col nzSpan="22"></div>
            <div nz-col nzSpan="2">
              <button nz-button nzType="primary" (click)="showModal(data, 'addProblem')"><i class="anticon anticon-search"></i>新增问题</button>
            </div>
          </div>
          <nz-table nzBordered #rowProblemTable [nzData]="problemInfo" [nzSimple]="true" nzShowSizeChanger [nzPageSize]="10" *ngIf="!isSpinning">
            <thead>
              <tr>
                <th>序号</th>
                <th>问题类型</th>
                <th>问题类型排序</th>
                <th>具体问题</th>
                <th>创建时间</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let data of rowProblemTable.data; let i=index;">
                <td>{{i + 1}}</td>
                <td>{{data.name}}</td>
                <td>{{data.sort}}</td>
                <td nzTitle="{{data.concreteProblems !== undefined && data.concreteProblems.length > 0 ? data.concreteProblems : ''}}" nzPlacement="bottom" nz-tooltip>
                  <a>{{data.concreteProblems !== undefined && data.concreteProblems.length > 0 ? data.concreteProblems.toString().substring(0, 7) + (data.concreteProblems.toString().length > 7 ? '……' : '') : ''}}</a>
                </td>
                <td>{{data.createDate | date:'yyyy-MM-dd HH:mm:ss'}}</td>
                <td>
                  <button nz-button nzType="primary" (click)="showModal(data, 'editProblem')" style="margin-right: 10px;"><i class="anticon anticon-edit"></i>修改</button>
                  <button nz-button nzType="primary" (click)="showModal(data, 'deleteProblem')"><i class="anticon anticon-delete"></i>删除</button>
                </td>
              </tr>
            </tbody>
          </nz-table>
          <div class="spin" *ngIf="isSpinning">
            <nz-spin [nzSize]="'large'"></nz-spin>
          </div>

          <nz-modal [(nzVisible)]="visiable.addProblem" nzWidth="750" nzTitle="新增问题" [nzFooter]="addProblemModalFooter" (nzOnCancel)="hideModal('addProblem')" nzMaskClosable="false">
            <form [formGroup]="addProblemForm">
              <div nz-row>
                <div nz-col nzSpan="5" class="right_alignment">问题类型：</div>
                <div nz-col nzSpan="19"><input nz-input placeholder="输入问题类型" [(ngModel)]="dataProblem.name" formControlName="name" nzSize="default"></div>
              </div>
              <div nz-row>
                <div nz-col nzSpan="5" class="right_alignment">问题排序：</div>
                <div nz-col nzSpan="19"><input nz-input placeholder="输入问题排序" [(ngModel)]="dataProblem.sort" formControlName="sort" nzSize="default"></div>
              </div>
              <div nz-row>
                <div nz-col nzSpan="5" class="right_alignment">具体问题：</div>
                <div nz-col nzSpan="19"><textarea rows="4" nz-input placeholder="输入具体问题" [(ngModel)]="dataProblem.concreteProblems" formControlName="concreteProblems" nzSize="default"></textarea></div>
              </div>
            </form>
            <ng-template #addProblemModalFooter>
                <button nz-button nzType="default" (click)="doSave('addProblem')"><i class="anticon anticon-save"></i>保存</button>
              <button nz-button nzType="default" (click)="hideModal('addProblem')"><i class="anticon anticon-close-circle-o"></i>取消</button>
            </ng-template>
          </nz-modal>

          <nz-modal [(nzVisible)]="visiable.editProblem" nzWidth="750" nzTitle="修改问题" [nzFooter]="editProblemModalFooter" (nzOnCancel)="hideModal('editProblem')" nzMaskClosable="false">
            <form [formGroup]="editProblemForm">
              <div nz-row>
                <div nz-col nzSpan="5" class="right_alignment">问题类型：</div>
                <div nz-col nzSpan="19"><input nz-input [(ngModel)]="dataProblem.name" formControlName="name" placeholder="输入问题类型" nzSize="default"></div>
              </div>
              <div nz-row>
                <div nz-col nzSpan="5" class="right_alignment">问题排序：</div>
                <div nz-col nzSpan="19"><input nz-input [(ngModel)]="dataProblem.sort" formControlName="sort" placeholder="输入问题排序" nzSize="default"></div>
              </div>
              <div nz-row>
                <div nz-col nzSpan="5" class="right_alignment">具体问题：</div>
                <div nz-col nzSpan="19"><textarea rows="4" nz-input [(ngModel)]="dataProblem.concreteProblems" formControlName="concreteProblems" placeholder="输入具体问题" nzSize="default"></textarea></div>
              </div>
            </form>
            <ng-template #editProblemModalFooter>
                <button nz-button nzType="default" (click)="doSave('editProblem')"><i class="anticon anticon-save"></i>保存</button>
              <button nz-button nzType="default" (click)="hideModal('editProblem')"><i class="anticon anticon-close-circle-o"></i>取消</button>
            </ng-template>
          </nz-modal>

        </nz-tab>

        <nz-tab [nzTitle]="oppositionTemplate" (nzClick)="changePanel('opposition')" *ngIf="commonService.haveMenuPermission('children', '点踩日志')">
          <ng-template #oppositionTemplate><i class="anticon anticon-dislike-o"></i>点踩日志</ng-template>
          <div nz-row>
            <form [formGroup]="oppositionSearchForm">
              <div nz-col nzSpan="3" class="right_alignment">
                用户账号：
              </div>
              <div nz-col nzSpan="4">
                <input nz-input maxlength="32" formControlName="userPhone" placeholder="输入用户账号" nzSize="default">
              </div>

              <div nz-col nzSpan="3" class="right_alignment">
                上传时间：
              </div>
              <div nz-col nzSpan="7">
                <nz-range-picker formControlName="date" [nzFormat]="'yyyy-MM-dd'" [nzShowToday]="true" ngModel [nzRanges]="commonService.dateSearch" (ngModelChange)="onChange($event, 'searchOpposition')"></nz-range-picker>
              </div>
            </form>
            <div nz-col nzSpan="1"></div>
            <div nz-col nzSpan="3">
              <button nz-button nzType="primary" (click)="loadData('opposition')"><i class="anticon anticon-search"></i>查询</button>
            </div>
            <div nz-col nzSpan="3">
              <button nz-button nzType="primary" (click)="showModal('', 'batchDownload')"><i class="anticon anticon-download"></i>批量导出</button>
            </div>
          </div>

          <nz-table nzBordered #rowOppositionTable [nzData]="oppositionInfo" [nzSimple]="true" nzShowSizeChanger [nzPageSize]="10" *ngIf="!isSpinning">
            <thead>
              <tr>
                <th>序号</th>
                <th>用户账号</th>
                <th>用户昵称</th>
                <th>点踩问句</th>
                <th>点踩回复</th>
                <th>业务BOT</th>
                <th>上传时间</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let data of rowOppositionTable.data; let i=index;">
                <td>{{i + 1}}</td>
                <td>{{data.phone ? data.phone : data.userId}}</td>
                <td>{{data.nickName ? data.nickName : data.userId}}</td>
                <td nzTitle="【{{data.session !== undefined && data.session.length > 0 ? data.session[data.session.length - 1].cpsAnswer !== undefined ? data.answer[0] : 'null' : 'null'}}】" nzPlacement="bottom" nz-tooltip>
                  <a>{{data.session !== undefined && data.session.length > 0 ? data.session[data.session.length - 1].cpsAnswer !== undefined ? data.session[data.session.length - 1].cpsAnswer.substring(0, 7) + '……' : 'null' : 'null'}}</a>
                </td>
                <td nzTitle="【{{data.session !== undefined && data.session.length > 0 ? data.session[data.session.length - 1].businessAnswer !== undefined ? data.ask[0] : 'null' : 'null'}}】" nzPlacement="bottom" nz-tooltip>
                  <a>{{data.session !== undefined && data.session.length > 0 ? data.session[data.session.length - 1].businessAnswer !== undefined ? data.session[data.session.length - 1].businessAnswer.substring(0, 7) + '……' : 'null' : 'null'}}</a>
                </td>
                <td>{{data.session !== undefined && data.session.length > 0 ? data.session[data.session.length - 1].business === 'FLIGHT' ? '机票' : data.session[data.session.length - 1].business === 'TRAIN' ? '火车票' : data.session[data.session.length - 1].business === 'HOTEL' ? '酒店' : data.session[data.session.length - 1].business === 'NAVIGATION' ? '导航' : data.session[data.session.length - 1].business === 'TAXI' ? '打车' : data.session[data.session.length - 1].business === 'MOVIE' ? '电影票' : data.session[data.session.length - 1].business === 'ERRAND' ? '闪送' : data.session[data.session.length - 1].business === 'WEATHER' ? '天气' : data.session[data.session.length - 1].business === 'MUSIC' ? '音乐' : data.session[data.session.length - 1].business === 'CALL' ? '打电话' : data.session[data.session.length - 1].business === 'RECHARGE' ? '充话费' : data.session[data.session.length - 1].business === 'NEWS' ? '新闻' : data.session[data.session.length - 1].business === 'HOROSCOPE' ? '星座' : data.session[data.session.length - 1].business === 'FREE_CHAT' ? '聊天' : data.session[data.session.length - 1].business === 'NAVICAR' ? '导航' : 'null' : 'null'}}</td>
                <td>{{data.date}}</td>
                <td>
                  <button nz-button nzType="primary" (click)="showModal(data, 'opposition')" style="margin-right: 10px;"><i class="anticon anticon-eye-o"></i>查看详情</button>
                </td>
              </tr>
            </tbody>
          </nz-table>
          <div class="spin" *ngIf="isSpinning">
            <nz-spin [nzSize]="'large'"></nz-spin>
          </div>

          <nz-modal [(nzVisible)]="visiable.opposition" nzWidth="1400" nzTitle="点踩对话日志详情" [nzFooter]="oppositionModalFooter" (nzOnCancel)="hideModal('opposition')" nzMaskClosable="false">
            <div nz-row>
              <div nz-col nzSpan="24">
                <button nz-button nzType="primary" (click)="getExcel('opposition')"><i class="anticon anticon-download"></i>导出点踩对话日志</button>
              </div>
            </div>

            <ng-container *ngIf="tempOpposition.session">
              <ng-container *ngFor="let item of tempOpposition.session">
                <div nz-row style="background-color: #DFF0D8;">
                  <div nz-col nzSpan="24">
                    <i class="anticon anticon-question"></i>
                    用户提问&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#bfbfbf">{{item.create}}</font>
                    <br>
                    {{item.ask}}
                  </div>
                </div>
                <div nz-row>
                  <div nz-col nzSpan="24">
                    <i class="anticon anticon-exclamation"></i>
                    齐悟回答&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#bfbfbf">{{item.create}}</font>
                    <br>
                    {{item.cpsAnswer}}
                  </div>
                </div>
                <div nz-row>
                  <div nz-col nzSpan="24">
                    <i class="anticon anticon-exclamation"></i>
                    子bot回答&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#bfbfbf">{{item.create}}</font>
                    <br>
                    {{item.businessAnswer}}
                  </div>
                </div>
              </ng-container>
            </ng-container>
            <ng-template #oppositionModalFooter>
              <button nz-button nzType="default" (click)="hideModal('opposition')"><i class="anticon anticon-close-circle-o"></i>取消</button>
            </ng-template>
          </nz-modal>
        </nz-tab>

        <nz-modal [(nzVisible)]="visiable.batchDownload" nzWidth="750" nzTitle="批量导出" [nzFooter]="batchDownloadModalFooter" (nzOnCancel)="hideModal('batchDownload')" nzMaskClosable="false">
          <form [formGroup]="batchDownloadForm">
            <div nz-row>
              <div nz-col nzSpan="6">
                <nz-radio-group formControlName="selected" [(ngModel)]="currentBatchSelected">
                  <label nz-radio nzValue="1" style="margin-bottom: 32px;">导出最新</label><br>
                  <label nz-radio nzValue="2" style="margin-bottom: 32px;">按时间导出</label><br>
                  <label nz-radio nzValue="3">按筛选条件导出</label>
                </nz-radio-group>
              </div>
              <div nz-col nzSpan="18">
                <div nz-row style="margin-bottom: 17px;">
                  <div nz-col nzSpan="12">
                    <input nz-input nzSize="default" formControlName="number" placeholder="输入数量">
                  </div>
                  <div nz-col nzSpan="12">
                    &nbsp;&nbsp;条
                  </div>
                </div>
                <div nz-row style="margin-bottom: 17px;">
                  <div nz-col nzSpan="12">
                    <nz-range-picker formControlName="date" [nzFormat]="'yyyy-MM-dd'" [nzShowToday]="true" ngModel [nzRanges]="commonService.dateSearch" (ngModelChange)="onChange($event, 'batchDownloadFirst')"></nz-range-picker>
                  </div>
                </div>
                <div nz-row style="margin-bottom: 17px;">
                  <div nz-col nzSpan="4">
                    用户账号：
                  </div>
                  <div nz-col nzSpan="12">
                    <input nz-input formControlName="userPhone" nzSize="default" placeholder="输入用户账号">
                  </div>
                </div>
                <div nz-row style="margin-bottom: 17px;">
                  <div nz-col nzSpan="4">
                    时间范围：
                  </div>
                  <div nz-col nzSpan="12">
                    <nz-range-picker formControlName="date" [nzFormat]="'yyyy-MM-dd'" [nzShowToday]="true" ngModel [nzRanges]="commonService.dateSearch" (ngModelChange)="onChange($event, 'batchDownloadSecond')"></nz-range-picker>
                  </div>
                </div>
              </div>
            </div>
          </form>
          <ng-template #batchDownloadModalFooter>
            <button nz-button nzType="primary" (click)="getExcel('allOpposition')"><i class="anticon anticon-download"></i>导出{{currentPanel === "opposition" ? '点踩' : '点赞'}}对话日志</button>
          </ng-template>
        </nz-modal>

        <nz-tab [nzTitle]="agreeTemplate" (nzClick)="changePanel('agree')" *ngIf="commonService.haveMenuPermission('children', '点赞日志')">
          <ng-template #agreeTemplate><i class="anticon anticon-like-o"></i>点赞日志</ng-template>
          <div nz-row>
            <form [formGroup]="agreeSearchForm">
              <div nz-col nzSpan="3" class="right_alignment">
                用户账号：
              </div>
              <div nz-col nzSpan="4">
                <input nz-input maxlength="32" formControlName="userPhone" placeholder="输入用户账号" nzSize="default">
              </div>
              <div nz-col nzSpan="3" class="right_alignment">
                上传时间：
              </div>
              <div nz-col nzSpan="7">
                <nz-range-picker formControlName="date" [nzFormat]="'yyyy-MM-dd'" [nzShowToday]="true" ngModel [nzRanges]="commonService.dateSearch" (ngModelChange)="onChange($event, 'searchAgree')"></nz-range-picker>
              </div>
            </form>
            <div nz-col nzSpan="1"></div>
            <div nz-col nzSpan="3">
              <button nz-button nzType="primary" (click)="loadData('agree')"><i class="anticon anticon-search"></i>查询</button>
            </div>
            <div nz-col nzSpan="3">
              <button nz-button nzType="primary" (click)="showModal('', 'batchDownload')"><i class="anticon anticon-download"></i>批量导出</button>
            </div>
          </div>

          <nz-table nzBordered #rowAgreeTable [nzData]="agreeInfo" [nzSimple]="true" nzShowSizeChanger [nzPageSize]="10" *ngIf="!isSpinning">
            <thead>
              <tr>
                <th>序号</th>
                <th>用户账号</th>
                <th>用户昵称</th>
                <th>点踩问句</th>
                <th>点踩回复</th>
                <th>业务BOT</th>
                <th>上传时间</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let data of rowAgreeTable.data; let i=index;">
                <td>{{i + 1}}</td>
                <td>{{data.phone ? data.phone : data.userId}}</td>
                <td>{{data.nickName ? data.nickName : data.userId}}</td>
                <td nzTitle="【{{data.session !== undefined && data.session.length > 0 ? data.session[data.session.length - 1].cpsAnswer !== undefined ? data.answer[0] : 'null' : 'null'}}】" nzPlacement="bottom" nz-tooltip>
                  <a>{{data.session !== undefined && data.session.length > 0 ? data.session[data.session.length - 1].cpsAnswer !== undefined ? data.session[data.session.length - 1].cpsAnswer.substring(0, 7) + '……' : 'null' : 'null'}}</a>
                </td>
                <td nzTitle="【{{data.session !== undefined && data.session.length > 0 ? data.session[data.session.length - 1].businessAnswer !== undefined ? data.ask[0] : 'null' : 'null'}}】" nzPlacement="bottom" nz-tooltip>
                  <a>{{data.session !== undefined && data.session.length > 0 ? data.session[data.session.length - 1].businessAnswer !== undefined ? data.session[data.session.length - 1].businessAnswer.substring(0, 7) + '……' : 'null' : 'null'}}</a>
                </td>
                <td>{{data.session !== undefined && data.session.length > 0 ? data.session[data.session.length - 1].business === 'FLIGHT' ? '机票' : data.session[data.session.length - 1].business === 'TRAIN' ? '火车票' : data.session[data.session.length - 1].business === 'HOTEL' ? '酒店' : data.session[data.session.length - 1].business === 'NAVIGATION' ? '导航' : data.session[data.session.length - 1].business === 'TAXI' ? '打车' : data.session[data.session.length - 1].business === 'MOVIE' ? '电影票' : data.session[data.session.length - 1].business === 'ERRAND' ? '闪送' : data.session[data.session.length - 1].business === 'WEATHER' ? '天气' : data.session[data.session.length - 1].business === 'MUSIC' ? '音乐' : data.session[data.session.length - 1].business === 'CALL' ? '打电话' : data.session[data.session.length - 1].business === 'RECHARGE' ? '充话费' : data.session[data.session.length - 1].business === 'NEWS' ? '新闻' : data.session[data.session.length - 1].business === 'HOROSCOPE' ? '星座' : data.session[data.session.length - 1].business === 'FREE_CHAT' ? '聊天' : data.session[data.session.length - 1].business === 'NAVICAR' ? '导航' : 'null' : 'null'}}</td>
                <td>{{data.date}}</td>
                <td>
                  <button nz-button nzType="primary" (click)="showModal(data, 'agree')" style="margin-right: 10px;"><i class="anticon anticon-eye-o"></i>查看详情</button>
                </td>
              </tr>
            </tbody>
          </nz-table>
          <div class="spin" *ngIf="isSpinning">
            <nz-spin [nzSize]="'large'"></nz-spin>
          </div>

          <nz-modal [(nzVisible)]="visiable.agree" nzWidth="1400" nzTitle="点赞对话日志详情" [nzFooter]="agreeModalFooter" (nzOnCancel)="hideModal('agree')" nzMaskClosable="false">
            <div nz-row>
              <div nz-col nzSpan="24">
                <button nz-button nzType="primary" (click)="getExcel('agree')"><i class="anticon anticon-download"></i>导出点赞对话日志</button>
              </div>
            </div>

            <ng-container *ngIf="tempAgree.session">
              <ng-container *ngFor="let item of tempAgree.session">
                <div nz-row style="background-color: #DFF0D8;">
                  <div nz-col nzSpan="24">
                    <i class="anticon anticon-question"></i>
                    用户提问&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#bfbfbf">{{item.create}}</font>
                    <br>
                    {{item.ask}}
                  </div>
                </div>
                <div nz-row>
                  <div nz-col nzSpan="24">
                    <i class="anticon anticon-exclamation"></i>
                    齐悟回答&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#bfbfbf">{{item.create}}</font>
                    <br>
                    {{item.cpsAnswer}}
                  </div>
                </div>
                <div nz-row>
                  <div nz-col nzSpan="24">
                    <i class="anticon anticon-exclamation"></i>
                    子bot回答&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#bfbfbf">{{item.create}}</font>
                    <br>
                    {{item.businessAnswer}}
                  </div>
                </div>
              </ng-container>
            </ng-container>
            <ng-template #agreeModalFooter>
              <button nz-button nzType="default" (click)="hideModal('agree')"><i class="anticon anticon-close-circle-o"></i>取消</button>
            </ng-template>
          </nz-modal>
        </nz-tab>

        <nz-tab [nzTitle]="invoiceTimeTemplate" (nzClick)="changePanel('invoiceTime')" *ngIf="commonService.haveMenuPermission('children', '开票时间管理')">
          <ng-template #invoiceTimeTemplate><i class="anticon anticon-clock-circle-o"></i>开票时间管理</ng-template>
          <div nz-row>
            <form [formGroup]="searchInvoiceTimeForm">
              <div nz-col nzSpan="2" class="right_alignment">
                用户账号：
              </div>
              <div nz-col nzSpan="2">
                <input nz-input maxlength="32" formControlName="phone" placeholder="输入用户账号" nzSize="default">
              </div>

              <div nz-col nzSpan="2" class="right_alignment">
                订单号：
              </div>
              <div nz-col nzSpan="2">
                <input nz-input maxlength="32" formControlName="orderId" placeholder="输入订单编号" nzSize="default">
              </div>

              <div nz-col nzSpan="2" class="right_alignment">
                订单类型：
              </div>
              <div nz-col nzSpan="3">
                <nz-select [ngModel]="1" formControlName="orderType">
                  <nz-option required [nzLabel]="'机票'" [nzValue]="1"></nz-option>
                  <nz-option required [nzLabel]="'酒店'" [nzValue]="3"></nz-option>
                  <nz-option required [nzLabel]="'打车'" [nzValue]="4"></nz-option>
                </nz-select>
              </div>

              <div nz-col nzSpan="2" class="right_alignment">
                订单时间：
              </div>
              <div nz-col nzSpan="7">
                <nz-range-picker formControlName="date" [nzFormat]="'yyyy-MM-dd'" [nzShowToday]="true" ngModel [nzRanges]="commonService.dateSearch" (ngModelChange)="onChange($event, 'invoiceTime')"></nz-range-picker>
              </div>

            </form>
            <div nz-col nzSpan="2">
              <button nz-button nzType="primary" (click)="loadData('invoiceTime')"><i class="anticon anticon-search"></i>查询</button>
            </div>
          </div>
          <nz-table nzBordered #rowInvoiceTimeTable [nzData]="invoiceTimeInfo.olderList" [nzSimple]="true" *ngIf="!isSpinning">
            <thead>
              <tr>
                <th>序号</th>
                <th>用户账号</th>
                <th>用户昵称</th>
                <th>订单号</th>
                <th>订单类型</th>
                <th>订单金额</th>
                <th>订单出行时间</th>
                <th>可开票状态</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let data of rowInvoiceTimeTable.data; let i=index;">
                <td>{{i + 1}}</td>
                <td>{{data.userAccountID}}</td>
                <td>{{data.userName}}</td>
                <td>{{data.orderId}}</td>
                <td>{{data.orderType === 0 || data.orderType === 1 ? '机票' : data.orderType === 2 ? '火车' : data.orderType === 3 ? '酒店' : data.orderType === 4 ? '打车' : 'null'}}</td>
                <td>{{data.money}}</td>
                <td>{{data.createTime}}</td>
                <td>
                  <nz-form-item>
                    <nz-form-control>
                      <nz-switch [(ngModel)]="data.drawBill" (click)="clickSwitch(data, 'invoiceTime')"></nz-switch>
                    </nz-form-control>
                  </nz-form-item>
                </td>
              </tr>
            </tbody>
          </nz-table>
          <div class="spin" *ngIf="isSpinning">
            <nz-spin [nzSize]="'large'"></nz-spin>
          </div>
        </nz-tab>

        <nz-tab [nzTitle]="invoiceLogTemplate" (nzClick)="changePanel('invoiceLog')" *ngIf="commonService.haveMenuPermission('children', '开票日志管理')">
          <ng-template #invoiceLogTemplate><i class="anticon anticon-file-text"></i>开票日志管理</ng-template>
          <div nz-row>
            <form [formGroup]="searchInvoiceLogForm">
              <div nz-col nzSpan="2" class="right_alignment">
                用户账号：
              </div>
              <div nz-col nzSpan="2">
                <input nz-input maxlength="32" formControlName="phone" placeholder="输入用户账号" nzSize="default">
              </div>

              <div nz-col nzSpan="2" class="right_alignment">
                订单号：
              </div>
              <div nz-col nzSpan="2">
                <input nz-input maxlength="32" formControlName="orderId" placeholder="输入订单编号" nzSize="default">
              </div>

              <div nz-col nzSpan="2" class="right_alignment">
                订单类型：
              </div>
              <div nz-col nzSpan="3">
                <nz-select [ngModel]="''" formControlName="orderType">
                  <nz-option required [nzLabel]="'全部'" [nzValue]="''"></nz-option>
                  <nz-option required [nzLabel]="'机票'" [nzValue]="1"></nz-option>
                  <nz-option required [nzLabel]="'火车'" [nzValue]="2"></nz-option>
                  <nz-option required [nzLabel]="'酒店'" [nzValue]="3"></nz-option>
                  <nz-option required [nzLabel]="'打车'" [nzValue]="4"></nz-option>
                </nz-select>
              </div>

              <div nz-col nzSpan="2" class="right_alignment">
                订单时间：
              </div>
              <div nz-col nzSpan="7">
                <nz-range-picker formControlName="date" [nzFormat]="'yyyy-MM-dd'" [nzShowToday]="true" ngModel [nzRanges]="commonService.dateSearch" (ngModelChange)="onChange($event, 'invoiceLog')"></nz-range-picker>
              </div>

            </form>
            <div nz-col nzSpan="2">
              <button nz-button nzType="primary" (click)="loadData('invoiceLog')"><i class="anticon anticon-search"></i>查询</button>
            </div>
          </div>
          <nz-table nzBordered #rowInvoiceLogTable [nzData]="invoiceLogInfo.adminBillLogsList" [nzSimple]="true" *ngIf="!isSpinning">
            <thead>
              <tr>
                <th>序号</th>
                <th>用户账号</th>
                <th>用户昵称</th>
                <th>订单号</th>
                <th>订单类型</th>
                <th>订单金额</th>
                <th>操作人</th>
                <th>操作时间</th>
                <th>操作动作</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let data of rowInvoiceLogTable.data; let i=index;">
                <td>{{i + 1}}</td>
                <td>{{data.userAccountID}}</td>
                <td>{{data.userName}}</td>
                <td>{{data.orderId}}</td>
                <td>{{data.orderType === 0 || data.orderType === 1 ? '机票' : data.orderType === 2 ? '火车' : data.orderType === 3 ? '酒店' : data.orderType === 4 ? '打车' : 'null'}}</td>
                <td>{{data.money}}</td>
                <td>{{data.adminName}}</td>
                <td>{{data.operaTime | date:'yyyy-MM-dd HH:mm:ss' }}</td>
                <td>{{data.open === true ? '开启可开票状态' : '关闭可开票状态'}}</td>
              </tr>
            </tbody>
          </nz-table>
          <div class="spin" *ngIf="isSpinning">
            <nz-spin [nzSize]="'large'"></nz-spin>
          </div>
        </nz-tab>

        <nz-tab [nzTitle]="businessTemplate" (nzClick)="changePanel('business')" *ngIf="commonService.haveMenuPermission('children', '商务合作') && currentAppHeader === 'XIAOWU'">
          <ng-template #businessTemplate><i class="anticon anticon-team"></i>商务合作</ng-template>
          <div nz-row>
            <form [formGroup]="searchBusinessForm">
              <div nz-col nzSpan="2" class="right_alignment">
                人名查询：
              </div>
              <div nz-col nzSpan="2">
                <input nz-input maxlength="32" formControlName="name" placeholder="输入人名查询" nzSize="default">
              </div>

              <div nz-col nzSpan="2" class="right_alignment">
                联系内容查询：
              </div>
              <div nz-col nzSpan="2">
                <input nz-input maxlength="32" formControlName="content" placeholder="输入联系内容查询" nzSize="default">
              </div>

              <div nz-col nzSpan="2" class="right_alignment">
                电话号码查询：
              </div>
              <div nz-col nzSpan="3">
                <input nz-input maxlength="32" formControlName="phone" placeholder="输入电话号码查询" nzSize="default">
              </div>

              <div nz-col nzSpan="2" class="right_alignment">
                日期查询：
              </div>
              <div nz-col nzSpan="7">
                <nz-range-picker formControlName="date" [nzFormat]="'yyyy-MM-dd'" [nzShowToday]="true" ngModel [nzRanges]="commonService.dateSearch" (ngModelChange)="onChange($event, 'business')"></nz-range-picker>
              </div>

            </form>
            <div nz-col nzSpan="2">
              <button nz-button nzType="primary" (click)="loadData('business')"><i class="anticon anticon-search"></i>查询</button>
            </div>
          </div>
          <nz-table nzBordered #rowBusinessTable [nzData]="businessInfo" [nzSimple]="true" nzShowSizeChanger [nzPageSize]="15" *ngIf="!isSpinning">
            <thead>
              <tr>
                <th>序号</th>
                <th>时间</th>
                <th>手机号</th>
                <th>姓名</th>
                <th>联系内容</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let data of rowBusinessTable.data; let i=index;">
                <td>{{i + 1}}</td>
                <td>{{data.createDate | date:'yyyy-MM-dd HH:mm:ss'}}</td>
                <td>{{data.phone}}</td>
                <td>{{data.name}}</td>
                <td nzTitle="{{data.content}}" nzPlacement="bottom" nz-tooltip>
                  <a>{{data.content.length > 12 ? data.content.substring(0, 12) + '…' : data.content}}</a>
                </td>
              </tr>
            </tbody>
          </nz-table>
          <div class="spin" *ngIf="isSpinning">
            <nz-spin [nzSize]="'large'"></nz-spin>
          </div>
        </nz-tab>

      </nz-tabset>
    </nz-card-tab>
  </nz-card>
</div>
